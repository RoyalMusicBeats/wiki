### Introduction
In this guide, we will be exploring how to set up K3s, a lightweight Kubernetes distribution, with Tailscale, a VPN that provides secure network connectivity between machines on the Internet. K3s is designed to be a lightweight and easy-to-install Kubernetes distribution that is ideal for use in resource-constrained environments, such as small edge devices, IoTdevices, and low-powered ARM-based devices. Tailscale provides a secure way to connect these devices to each other and to the Internet, without the need for complex networking configurations. By combining K3s with Tailscale, we can create a simple, secure, and scalable Kubernetes cluster that is easy to set up and manage.
#### Installing and configuring Tailscale
Install the Tailscale client by running the following command:
```sh
curl -fsSL https://tailscale.com/install.sh | sh
```
After installing Tailscale, you can authenticate your device by running the following command:
```sh
sudo tailscale up
```
After joining the Tailscale network, you can verify that your device is connected by running the following command:
```sh
tailscale status
```
This needs to be done on every worker en master node.
#### Setup the first K3s master node
To register our K3s master node, we can use the following command:
```sh
curl -sfL https://get.k3s.io | K3S_TOKEN=YOUR-TOKEN sh -s - server --cluster-init --flannel-iface tailscale0
```
???+ note "Here's a breakdown of the various components of this command:"
    - curl: This is a command-line utility for transferring data from or to a server, using various protocols. In this case, it is used to download the script from the given URL.
    - -sfL: These are options to the curl command. -s tells curl to operate silently, without showing progress or error messages. -f tells curl to fail silently if the HTTP response code indicates an error. -L tells curl to follow redirects if the server sends them.
    - https://get.k3s.io: This is the URL from which the script is downloaded.
    - |: This is a pipe symbol that connects the output of the curl command to the input of the next command, which is sh.
    - K3S_TOKEN="YOUR-TOKEN": This sets an environment variable called K3S_TOKEN to the value YOUR-TOKEN. The environment variable will be available to the script that is run by sh.
    - sh: This is the command that runs the script that was downloaded by curl. The script is executed by the shell program sh.
    - -s: This option tells the shell program sh to read commands from standard input (i.e., the pipe from curl) instead of from a script file.
    - -server --cluster-init --flannel-iface tailscale0: These are arguments that are passed to the script that is executed by sh. The script is a script to install the K3s Kubernetes distribution, and these arguments configure the installation. --cluster-init configures K3s to set up a new Kubernetes cluster. --flannel-iface tailscale0 configures the Flannel networkinterface to use tailscale0.
#### Retrieving the full-token from our k3s master server
To retrieve the token from a K3s server, we can use the following command:
```sh
cat /var/lib/rancher/k3s/server/token
```
This will display the token value that was generated during the installation of the K3s server. 
!!! danger
    The token is used to authenticate new nodes that are added to the Kubernetes cluster. Be sure to keep the token value secure, as it provides full access to the Kubernetes API server.

#### Adding another K3s master server
On the new master server, run the following command to join the cluster:
```sh
curl -sfL https://get.k3s.io | K3S_TOKEN=YOUR-FULL-TOKEN sh -s - server --server https://YOUR-TAILSCALE-IP:6443  --flannel-iface tailscale0
```
???+ note "Here's a breakdown of the various components of this command:"
    - K3S_TOKEN="YOUR-FULL-TOKEN": This sets the token value for the K3s server installation. Replace "YOUR-TOKEN" with the token value generated by the K3s master node.
    - sh -s - server: This executes the downloaded K3s installation script with the server parameter, indicating that this is a K3s server node.
    - --server https://YOUR-TAILSCALE-IP:6443: This specifies the IP address of the K3s server node that is being installed. Replace "YOUR-TAILSCALE-IP" with the IP address of the first master server.
    - --flannel-iface tailscale0: This specifies the Tailscale virtual network interface to use for communication between the K3s nodes.

By following these steps, you should now have a multi-master K3s cluster with two master servers. You can repeat these steps to add additional master servers to the cluster if desired.
#### Adding a K3s agent node
```sh
curl -sfL https://get.k3s.io | K3S_TOKEN=YOUR-FULL-TOKEN K3S_URL=https://YOUR-TAILSCALE-IP:6443 sh -s - --flannel-iface tailscale0
```
#### Optional: Installing longhorn
[Installing longhorn on K3s](https://wiki.rschmits.com/books/k3s-with-tailscale/page/installing-longhorn-on-k3s)
#### Trouble
``` sh
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
```
```
https://longhorn.io/kb/troubleshooting-dns-resolution-failed/
```